<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
	<title>Title</title>
	<style>
		body {
			width: 100%;
			max-width: 400px;
			margin: 0;
			padding: 8px;
		}

		p {
			margin: 0;
		}

		ul {
			list-style: none;
		}

		.list-child {
			padding: 4px;
			margin: 8px 8px 0;
			border-radius: 8px;
			border-color: cornflowerblue;
			border-width: 2px;
			border-style: solid;
			display: flex;
			justify-content: space-between;
		}

		.list-child.temp {
			border-color: dimgray;
		}
	</style>
	<script
			src="https://code.jquery.com/jquery-3.3.1.min.js"
			integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			crossorigin="anonymous"></script>
</head>
<body>
<p>Connection state: <span id="server-status">Unknown</span></p>
<br>
<label>
	<input id="item-item-text" type="text">
</label>
<button onclick="addItem()">Add item</button>
<button onclick="addTempItem()">Add temp</button>
<div id="list-root"></div>
<img id="hidden-image-for-state" alt="" style="display: none">
<script>
	var currentId = 5;

	function addItem() {
		// const node = document.getElementById('list-root');
		// const element = document.createElement('li');
		// node.appendChild(element)
		const item = createItemForId(currentId);
		currentId++;
		console.log(`current id : ${currentId}`);

		$('#list-root').append(item);

		// TODO persist to local store
	}

	function addTempItem() {
		// const node = document.getElementById('list-root');
		// const element = document.createElement('li');
		// node.appendChild(element)
		const item = createTempItemForId(currentId);
		currentId++;
		console.log(`current id : ${currentId}`);

		$('#list-root').append(item);

		// TODO persist to local store
	}

	function deleteItem(itemId) {
		$(`#item-${itemId}`).remove();
		console.log(`Removed element ` + `#item-${itemId}`)
		// TODO remove from local store
	}

	function deleteTempItem(itemId) {
		$(`#temp-${itemId}`).remove();
		console.log(`Removed element ` + `#temp-${itemId}`)
		// TODO remove from local store
	}

	function createItemForId(itemId) {
		const val = $('#item-item-text').val();
		const el =
			`<div class="list-child" id="item-${itemId}">
			<div class="text">${val}</div>
			<button onclick="deleteItem(${itemId})">X</button>
			</div>`;
		return $.parseHTML(el);
	}

	function createTempItemForId(itemId) {
		const val = $('#item-item-text').val();
		const el =
			`<div class="list-child temp" id="temp-${itemId}">
			<div class="text">${val}</div>
			<button onclick="deleteTempItem(${itemId})">X</button>
			</div>`;
		return $.parseHTML(el);
	}

	// const onlineEvent = new CustomEvent('wasOnline',{detail:data});

	function isServerOnline() {
		// if (func === 'undefined') return;
		$.get('/ping', function (data) {
			// console.log('online');
			// //TODO add online event
			//   func('online');
			dispatchEvent(new CustomEvent('wasOnline'))
		}).fail(function () {
			dispatchEvent(new CustomEvent('wasOffline'))
		});
	}

	function refresh() {
		isServerOnline();
		setTimeout(refresh, 500);
	}

	refresh();

	addEventListener('wasOnline', () => {
		updateServerState('online')
	});
	addEventListener('wasOffline', () => {
		updateServerState('offline')
	});

	function updateServerState(state) {
		if (state === 'undefined') return;
		if (state === 'online') {
			$('#server-status').text("online!");
		} else if (state === 'offline') {
			$('#server-status').text("offline!");
		}
	}

	// network methods
	function addItem(description)
	{

	}

	function deleteItem(id)
	{

	}
</script>
</body>
</html>